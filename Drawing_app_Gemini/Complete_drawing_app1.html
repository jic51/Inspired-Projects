<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rainbow Drawing App</title>
    <style>
        /* General Styling */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top */
            min-height: 100vh;
            background-color: #f0f2f5;
            margin: 0;
            padding-top: 20px;
        }

        .app-container {
            width: 90%;
            max-width: 900px;
            background-color: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        h1 {
            font-size: 2.5em;
            font-weight: bold;
            background: linear-gradient(90deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: rainbow-flow 5s linear infinite;
            background-size: 400% 100%;
        }

        @keyframes rainbow-flow {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }

        /* Login Screen Styling */
        #auth-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px;
        }
        #username-input {
            font-size: 1.2em;
            padding: 10px;
            border: 2px solid #ccc;
            border-radius: 8px;
            margin-bottom: 20px;
            width: 80%;
            max-width: 300px;
            text-align: center;
        }
        #login-button {
            font-size: 1.1em;
            padding: 12px 25px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            background-color: #007bff;
            color: white;
            transition: background-color 0.3s;
        }
        #login-button:hover {
            background-color: #0056b3;
        }

        /* Main Drawing App Styling (Hidden by default) */
        #main-app {
            display: none; /* Initially hidden */
        }

        #user-info {
            text-align: right;
            margin-bottom: 10px;
            color: #555;
        }
        #logout-button {
            background: none;
            border: none;
            color: #007bff;
            cursor: pointer;
            text-decoration: underline;
            font-size: 0.9em;
        }

        /* Canvas and Controls */
        canvas {
            border: 2px solid #ddd;
            border-radius: 8px;
            background-color: #fdfdfd;
            cursor: crosshair;
            display: block;
            margin: 15px auto;
            touch-action: none; /* Prevents scrolling on canvas on mobile */
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        .controls button, .controls select {
            padding: 10px 15px;
            font-size: 1em;
            cursor: pointer;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f8f8f8;
        }
        .controls button:hover, .controls select:hover {
            background-color: #e9e9e9;
        }
    </style>
</head>
<body>

    <div class="app-container">
        <h1>Rainbow Drawing</h1>

        <div id="auth-screen">
            <h2>Welcome!</h2>
            <p>Please enter a username to save your drawings.</p>
            <input type="text" id="username-input" placeholder="Enter your name">
            <button id="login-button">Start Drawing</button>
        </div>

        <div id="main-app">
            <div id="user-info">
                Logged in as: <strong id="username-display"></strong>
                <button id="logout-button">Logout</button>
            </div>

            <canvas id="drawingCanvas" width="800" height="500"></canvas>
            
            <div class="controls">
                <button id="clearButton">Clear</button>
                <button id="saveButton">Save Drawing</button>
                <select id="savedDrawingsDropdown">
                    <option value="">Load a Drawing</option>
                </select>
                <button id="downloadStaticButton">Download Image</button>
                <button id="downloadVideoButton">Download Video</button>
            </div>
            
            <div id="statusMessage"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ccapture.js@1.1.0/build/CCapture.all.min.js"></script>
    <script>
        // --- DOM Elements ---
        const authScreen = document.getElementById('auth-screen');
        const mainApp = document.getElementById('main-app');
        const usernameInput = document.getElementById('username-input');
        const loginButton = document.getElementById('login-button');
        const usernameDisplay = document.getElementById('username-display');
        const logoutButton = document.getElementById('logout-button');
        
        const canvas = document.getElementById('drawingCanvas');
        const ctx = canvas.getContext('2d');
        const clearButton = document.getElementById('clearButton');
        const saveButton = document.getElementById('saveButton');
        const savedDrawingsDropdown = document.getElementById('savedDrawingsDropdown');
        const downloadStaticButton = document.getElementById('downloadStaticButton');
        const downloadVideoButton = document.getElementById('downloadVideoButton');
        const statusMessage = document.getElementById('statusMessage');

        // --- App State ---
        let isDrawing = false;
        let hue = 0;
        let brushWidth = 5;
        let recordedStrokes = [];
        let lastTimestamp = 0;
        let currentUser = null;

        // --- Authentication Logic ---
        function checkLoginState() {
            currentUser = localStorage.getItem('rainbowDrawUser');
            if (currentUser) {
                // User is logged in
                usernameDisplay.textContent = currentUser;
                authScreen.style.display = 'none';
                mainApp.style.display = 'block';
                populateSavedDrawings();
            } else {
                // User is not logged in
                authScreen.style.display = 'flex';
                mainApp.style.display = 'none';
            }
        }

        loginButton.addEventListener('click', () => {
            const username = usernameInput.value.trim();
            if (username) {
                localStorage.setItem('rainbowDrawUser', username);
                checkLoginState();
            } else {
                alert('Please enter a username.');
            }
        });

        logoutButton.addEventListener('click', () => {
            localStorage.removeItem('rainbowDrawUser');
            currentUser = null;
            recordedStrokes = [];
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            checkLoginState();
        });


        // --- Drawing Logic ---
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';

        function getRainbowColor() {
            hue = (hue + 1) % 360;
            return `hsl(${hue}, 100%, 50%)`;
        }

        function getEventCoords(e) {
            const rect = canvas.getBoundingClientRect();
            if (e.touches && e.touches.length > 0) {
                return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
            }
            return { x: e.offsetX, y: e.offsetY };
        }

        function startDrawing(e) {
            e.preventDefault();
            isDrawing = true;
            const { x, y } = getEventCoords(e);
            ctx.lineWidth = brushWidth;
            ctx.strokeStyle = getRainbowColor();
            ctx.beginPath();
            ctx.moveTo(x, y);

            lastTimestamp = performance.now();
            recordedStrokes.push({ type: 'start', x, y, color: ctx.strokeStyle, width: brushWidth, timestampOffset: 0 });
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();
            const { x, y } = getEventCoords(e);
            ctx.lineTo(x, y);
            ctx.stroke();

            const currentTimestamp = performance.now();
            recordedStrokes.push({ type: 'draw', x, y, color: ctx.strokeStyle, width: brushWidth, timestampOffset: currentTimestamp - lastTimestamp });
            lastTimestamp = currentTimestamp;
        }

        function stopDrawing() {
            if (!isDrawing) return;
            isDrawing = false;
            ctx.closePath();
            recordedStrokes.push({ type: 'end', timestampOffset: 0 });
        }

        // --- Event Listeners ---
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        canvas.addEventListener('touchstart', startDrawing, { passive: false });
        canvas.addEventListener('touchmove', draw, { passive: false });
        canvas.addEventListener('touchend', stopDrawing);
        canvas.addEventListener('touchcancel', stopDrawing);
        
        clearButton.addEventListener('click', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            recordedStrokes = [];
            savedDrawingsDropdown.value = "";
            statusMessage.textContent = 'Canvas cleared!';
        });

        // --- Save and Load Logic ---
        function getDrawingsForCurrentUser() {
            const allDrawings = JSON.parse(localStorage.getItem('rainbowDrawings') || '{}');
            return allDrawings[currentUser] || [];
        }

        function saveDrawingForCurrentUser(drawingData) {
            const allDrawings = JSON.parse(localStorage.getItem('rainbowDrawings') || '{}');
            if (!allDrawings[currentUser]) {
                allDrawings[currentUser] = [];
            }
            allDrawings[currentUser].push(drawingData);
            localStorage.setItem('rainbowDrawings', JSON.stringify(allDrawings));
        }
        
        saveButton.addEventListener('click', () => {
            if (recordedStrokes.length === 0) {
                statusMessage.textContent = 'Draw something before saving!';
                return;
            }
            const drawingName = prompt("Enter a name for your drawing:");
            if (drawingName) {
                const drawingData = {
                    name: drawingName,
                    strokes: recordedStrokes,
                    timestamp: new Date().toISOString()
                };
                saveDrawingForCurrentUser(drawingData);
                populateSavedDrawings();
                statusMessage.textContent = `Drawing "${drawingName}" saved!`;
            }
        });

        function populateSavedDrawings() {
            const drawings = getDrawingsForCurrentUser();
            savedDrawingsDropdown.innerHTML = '<option value="">Load a Drawing</option>';
            drawings.forEach((drawing, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = drawing.name;
                savedDrawingsDropdown.appendChild(option);
            });
        }
        
        savedDrawingsDropdown.addEventListener('change', (e) => {
            const drawingIndex = e.target.value;
            if (drawingIndex === "") {
                clearButton.click();
                return;
            }
            const drawings = getDrawingsForCurrentUser();
            const drawingToLoad = drawings[drawingIndex];
            if (drawingToLoad) {
                recordedStrokes = drawingToLoad.strokes;
                replayDrawing(recordedStrokes, canvas, true); // Replay instantly
                statusMessage.textContent = `Loaded "${drawingToLoad.name}".`;
            }
        });

        async function replayDrawing(strokes, targetCanvas, instant = false) {
            const replayCtx = targetCanvas.getContext('2d');
            replayCtx.clearRect(0, 0, targetCanvas.width, targetCanvas.height);
            
            for (const stroke of strokes) {
                if (!instant && stroke.timestampOffset > 0) {
                    await new Promise(resolve => setTimeout(resolve, stroke.timestampOffset));
                }

                switch (stroke.type) {
                    case 'start':
                        replayCtx.lineWidth = stroke.width;
                        replayCtx.strokeStyle = stroke.color;
                        replayCtx.beginPath();
                        replayCtx.moveTo(stroke.x, stroke.y);
                        break;
                    case 'draw':
                        replayCtx.lineTo(stroke.x, stroke.y);
                        replayCtx.stroke();
                        break;
                    case 'end':
                        replayCtx.closePath();
                        break;
                }
            }
        }

        // --- Download Logic ---
        downloadStaticButton.addEventListener('click', () => {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            
            // Draw a white background
            tempCtx.fillStyle = '#FFFFFF';
            tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            
            // Draw the existing canvas content on top
            tempCtx.drawImage(canvas, 0, 0);

            // Download the image
            const link = document.createElement('a');
            link.download = `rainbow-drawing-${Date.now()}.png`;
            link.href = tempCanvas.toDataURL('image/png');
            link.click();
            statusMessage.textContent = 'Image download started!';
        });

        downloadVideoButton.addEventListener('click', async () => {
            if (recordedStrokes.length === 0) {
                statusMessage.textContent = 'Draw something to record a video!';
                return;
            }

            statusMessage.textContent = 'Preparing video... this may take a moment.';

            const capturer = new CCapture({
                format: 'webm',
                framerate: 60,
                verbose: false
            });

            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.fillStyle = '#FFFFFF';
            tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

            capturer.start();

            // Custom replay for video capture
            for (const stroke of recordedStrokes) {
                switch (stroke.type) {
                    case 'start':
                        tempCtx.lineWidth = stroke.width;
                        tempCtx.strokeStyle = stroke.color;
                        tempCtx.beginPath();
                        tempCtx.moveTo(stroke.x, stroke.y);
                        break;
                    case 'draw':
                        tempCtx.lineTo(stroke.x, stroke.y);
                        tempCtx.stroke();
                        break;
                    case 'end':
                        tempCtx.closePath();
                        break;
                }
                // Capture a frame after each drawing action
                capturer.capture(tempCanvas);
            }
            
            capturer.stop();
            capturer.save();
            statusMessage.textContent = 'Video download started!';
        });

        // --- Initial Load ---
        checkLoginState();

    </script>
</body>
</html>
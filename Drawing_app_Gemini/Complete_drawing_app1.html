<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rainbow Drawing App</title>
    <style>
        /* General Styling */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            background-color: #f0f2f5;
            margin: 0;
            padding-top: 20px;
        }

        .app-container {
            width: 90%;
            max-width: 900px;
            background-color: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        /* NEW: Seamless Rainbow Title Animation */
        h1 {
            font-size: 2.5em;
            font-weight: bold;
            background: linear-gradient(90deg, 
                #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #9400d3,
                #ff0000); /* Repeat the first color for a seamless loop */
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: rainbow-flow 10s linear infinite;
            background-size: 200% auto; /* Make background wider than the element */
        }

        @keyframes rainbow-flow {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }

        /* Login Screen Styling */
        #auth-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px;
        }
        #username-input {
            font-size: 1.2em;
            padding: 10px;
            border: 2px solid #ccc;
            border-radius: 8px;
            margin-bottom: 20px;
            width: 80%;
            max-width: 300px;
            text-align: center;
        }
        #login-button {
            font-size: 1.1em;
            padding: 12px 25px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            background-color: #007bff;
            color: white;
            transition: background-color 0.3s;
        }
        #login-button:hover {
            background-color: #0056b3;
        }

        /* Main Drawing App Styling */
        #main-app { display: none; }
        
        /* NEW: Wrapper for Canvas and Floating UI */
        .canvas-wrapper {
            position: relative; /* This is the anchor for absolute children */
            width: 800px;
            height: 500px;
            margin: 15px auto;
        }

        canvas {
            border: 2px solid #ddd;
            border-radius: 8px;
            background-color: #fdfdfd;
            cursor: crosshair;
            display: block;
            touch-action: none;
        }
        
        /* NEW: User Profile (Top Right) */
        #user-profile {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(5px);
            padding: 5px 10px;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }
        #username-display { font-weight: 600; }
        #logout-button {
            background: none; border: none; color: #007bff;
            cursor: pointer; text-decoration: underline; font-size: 0.8em;
            padding: 0; margin-left: 5px;
        }

        /* NEW: Floating Controls (Top Left) */
        .floating-controls {
            position: absolute;
            top: 15px;
            left: 15px;
            display: flex;
            gap: 10px;
        }
        .floating-controls button {
            padding: 8px 12px;
            font-size: 1em;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(5px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: background-color 0.2s;
        }
        .floating-controls button:hover {
            background-color: rgba(255, 255, 255, 1);
        }

        /* NEW: Save Button Dropdown */
        .save-container { position: relative; }
        .save-options {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 5px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            overflow: hidden;
            flex-direction: column;
            width: 120px;
        }
        .save-options button {
            width: 100%;
            border-radius: 0;
            box-shadow: none;
            text-align: left;
        }
    </style>
</head>
<body>

    <div class="app-container">
        <h1>Rainbow Drawing</h1>

        <div id="auth-screen">
            <h2>Welcome!</h2>
            <p>Please enter a username to begin.</p>
            <input type="text" id="username-input" placeholder="Enter your name">
            <button id="login-button">Start Drawing</button>
        </div>

        <div id="main-app">
            <div class="canvas-wrapper">
                <canvas id="drawingCanvas" width="800" height="500"></canvas>
                
                <div id="user-profile">
                    <img id="user-avatar" src="" alt="User Avatar">
                    <span id="username-display"></span>
                    <button id="logout-button">Logout</button>
                </div>

                <div class="floating-controls">
                    <button id="undoButton">‚Ü©Ô∏è Undo</button>
                    <div class="save-container">
                        <button id="saveButton">üíæ Save</button>
                        <div class="save-options" id="saveOptions">
                            <button id="downloadStaticButton">‚¨áÔ∏è Image</button>
                            <button id="downloadVideoButton">üé¨ Video</button>
                        </div>
                    </div>
                    <button id="sendButton">‚úâÔ∏è Send</button>
                </div>
            </div>
            <div id="statusMessage" style="margin-top:10px;"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ccapture.js@1.1.0/build/CCapture.all.min.js"></script>
    <script>
        // --- DOM Elements ---
        const authScreen = document.getElementById('auth-screen');
        const mainApp = document.getElementById('main-app');
        const usernameInput = document.getElementById('username-input');
        const loginButton = document.getElementById('login-button');
        const userProfile = document.getElementById('user-profile');
        const userAvatar = document.getElementById('user-avatar');
        const usernameDisplay = document.getElementById('username-display');
        const logoutButton = document.getElementById('logout-button');
        
        const canvas = document.getElementById('drawingCanvas');
        const ctx = canvas.getContext('2d');
        const statusMessage = document.getElementById('statusMessage');

        // New Floating Buttons
        const undoButton = document.getElementById('undoButton');
        const saveButton = document.getElementById('saveButton');
        const saveOptions = document.getElementById('saveOptions');
        const downloadStaticButton = document.getElementById('downloadStaticButton');
        const downloadVideoButton = document.getElementById('downloadVideoButton');
        const sendButton = document.getElementById('sendButton');

        // --- App State ---
        let isDrawing = false;
        let hue = 0;
        let brushWidth = 4; // Thickness set to 4
        let recordedStrokes = [];
        let lastTimestamp = 0;
        let currentUser = null;

        // --- Authentication & Profile ---
        function checkLoginState() {
            currentUser = localStorage.getItem('rainbowDrawUser');
            if (currentUser) {
                usernameDisplay.textContent = currentUser;
                userAvatar.src = generateAvatar(currentUser);
                authScreen.style.display = 'none';
                mainApp.style.display = 'block';
            } else {
                authScreen.style.display = 'flex';
                mainApp.style.display = 'none';
            }
        }

        loginButton.addEventListener('click', () => {
            const username = usernameInput.value.trim();
            if (username) {
                localStorage.setItem('rainbowDrawUser', username);
                checkLoginState();
            } else {
                alert('Please enter a username.');
            }
        });

        logoutButton.addEventListener('click', () => {
            localStorage.removeItem('rainbowDrawUser');
            checkLoginState();
        });

        // NEW: Generate a simple avatar from user initials
        function generateAvatar(name) {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = 64;
            canvas.height = 64;

            const initials = name.split(' ').map(n => n[0]).slice(0, 2).join('').toUpperCase();
            const colors = ['#007bff', '#6610f2', '#6f42c1', '#e83e8c', '#dc3545', '#fd7e14', '#ffc107', '#28a745', '#20c997', '#17a2b8'];
            const colorIndex = (initials.charCodeAt(0) || 0) % colors.length;
            
            context.fillStyle = colors[colorIndex];
            context.fillRect(0, 0, canvas.width, canvas.height);
            context.font = 'bold 32px Arial';
            context.fillStyle = '#fff';
            context.textAlign = 'center';
            context.textBaseline = 'middle';
            context.fillText(initials, canvas.width / 2, canvas.height / 2);

            return canvas.toDataURL();
        }

        // --- Drawing Logic ---
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';

        function getRainbowColor() {
            hue = (hue + 1.5) % 360; // Increased increment for faster color change
            return `hsl(${hue}, 100%, 50%)`;
        }
        
        function getEventCoords(e) {
            const rect = canvas.getBoundingClientRect();
            if (e.touches && e.touches.length > 0) {
                return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
            }
            return { x: e.offsetX, y: e.offsetY };
        }

        function startDrawing(e) {
            e.preventDefault();
            isDrawing = true;
            const { x, y } = getEventCoords(e);
            ctx.lineWidth = brushWidth;
            
            ctx.beginPath();
            ctx.moveTo(x, y);

            lastTimestamp = performance.now();
            recordedStrokes.push({ type: 'start', x, y, width: brushWidth, timestampOffset: 0 });
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();
            
            // NEW: Update color on every segment for true rainbow effect
            ctx.strokeStyle = getRainbowColor();
            
            const { x, y } = getEventCoords(e);
            ctx.lineTo(x, y);
            ctx.stroke();

            const currentTimestamp = performance.now();
            recordedStrokes.push({ type: 'draw', x, y, color: ctx.strokeStyle, timestampOffset: currentTimestamp - lastTimestamp });
            lastTimestamp = currentTimestamp;
        }

        function stopDrawing() {
            if (!isDrawing) return;
            isDrawing = false;
            ctx.closePath();
            recordedStrokes.push({ type: 'end', timestampOffset: 0 });
        }

        // --- Redraw Canvas from Strokes ---
        function redrawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (const stroke of recordedStrokes) {
                switch (stroke.type) {
                    case 'start':
                        ctx.lineWidth = stroke.width;
                        ctx.beginPath();
                        ctx.moveTo(stroke.x, stroke.y);
                        break;
                    case 'draw':
                        ctx.strokeStyle = stroke.color;
                        ctx.lineTo(stroke.x, stroke.y);
                        ctx.stroke();
                        break;
                    case 'end':
                        ctx.closePath();
                        break;
                }
            }
        }
        
        // --- Event Listeners ---
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        canvas.addEventListener('touchstart', startDrawing, { passive: false });
        canvas.addEventListener('touchmove', draw, { passive: false });
        canvas.addEventListener('touchend', stopDrawing);

        // NEW: Undo Button Logic
        undoButton.addEventListener('click', () => {
            if (recordedStrokes.length === 0) return;
            // Find the last 'start' point
            let lastStartIndex = -1;
            for (let i = recordedStrokes.length - 1; i >= 0; i--) {
                if (recordedStrokes[i].type === 'start') {
                    lastStartIndex = i;
                    break;
                }
            }
            if (lastStartIndex !== -1) {
                recordedStrokes.splice(lastStartIndex); // Remove the last stroke
                redrawCanvas(); // Redraw the canvas with the remaining strokes
            }
        });

        // NEW: Save Dropdown Logic
        saveButton.addEventListener('click', () => {
            saveOptions.style.display = saveOptions.style.display === 'flex' ? 'none' : 'flex';
        });
        document.addEventListener('click', (e) => {
            if (!saveButton.contains(e.target) && !saveOptions.contains(e.target)) {
                saveOptions.style.display = 'none';
            }
        });
        
        // NEW: Placeholder Send Button
        sendButton.addEventListener('click', () => {
            alert('Send functionality is not yet implemented. This is where you could add code to email or share the drawing!');
        });

        // --- Download Logic ---
        downloadStaticButton.addEventListener('click', () => {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width; tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.fillStyle = '#FFFFFF';
            tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            tempCtx.drawImage(canvas, 0, 0);

            const link = document.createElement('a');
            link.download = `rainbow-drawing-${Date.now()}.png`;
            link.href = tempCanvas.toDataURL('image/png');
            link.click();
            statusMessage.textContent = 'Image download started!';
            saveOptions.style.display = 'none';
        });

        downloadVideoButton.addEventListener('click', async () => {
            if (recordedStrokes.length === 0) {
                statusMessage.textContent = 'Draw something to record a video!';
                return;
            }
            statusMessage.textContent = 'Preparing video... this may take a moment.';

            const capturer = new CCapture({ format: 'webm', framerate: 60 });
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width; tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.fillStyle = '#FFFFFF';
            tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            
            capturer.start();

            for (const stroke of recordedStrokes) {
                switch (stroke.type) {
                    case 'start':
                        tempCtx.lineWidth = stroke.width;
                        tempCtx.beginPath();
                        tempCtx.moveTo(stroke.x, stroke.y);
                        break;
                    case 'draw':
                        tempCtx.strokeStyle = stroke.color;
                        tempCtx.lineTo(stroke.x, stroke.y);
                        tempCtx.stroke();
                        break;
                    case 'end':
                        tempCtx.closePath();
                        break;
                }
                capturer.capture(tempCanvas);
            }
            
            capturer.stop();
            capturer.save();
            statusMessage.textContent = 'Video download started!';
            saveOptions.style.display = 'none';
        });

        // --- Initial Load ---
        checkLoginState();
    </script>
</body>
</html>